name: å‘å¸ƒ

on: [workflow_dispatch]

jobs:
  build-and-prerelease:
    uses: ARS-MC/RRDC/.github/workflows/build.yml@main
  release:
    runs-on: ubuntu-latest
    needs: build-and-prerelease
    steps:
      - uses: dev-drprasad/delete-older-releases@v0.2.0
        with:
          keep_latest: 0
          delete_tags: true
          delete_tag_pattern: ${{ format('build-{0}', github.run_number) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v2
      - name: å®‰è£…ä¾èµ–
        run: sudo apt install -y pdftk
      - name: èŽ·å–æœ€åŽä¸€æœŸçš„ç¼–å·
        shell: python
        run: |
          from os import walk, environ
          from re import match as re_match
          latest = 0
          for dir in next(walk('.'))[1]:
              m = re_match('ç¬¬(\d+)æœŸ', dir)
              if m is not None:
                  number = int(m.group(1))
                  if number > latest:
                      latest = number
          with open(environ['GITHUB_ENV'], 'w', encoding='utf8') as f:
              print(f'LATEST={latest}', file=f)
      - uses: actions/download-artifact@v2.1.0
        with:
          name: pdfs
          path: ./pdfs/
      - name: é‡å‘½å pdf æ–‡ä»¶å¹¶ç”Ÿæˆ release ä¿¡æ¯
        shell: python
        run: |
          from os import environ, popen, rename
          from json import load
          from pathlib import Path
          latest = environ['LATEST']
          root = Path(f'./ç¬¬{latest}æœŸ/æ‚é¡¹/')
          pdfs_root = Path('./pdfs/')
          with open(root / 'ç›®å½•.json', 'r', encoding='utf8') as f:
              contents = load(f)
          rename(pdfs_root / f'ç¬¬{latest}æœŸ.pdf', pdfs_root / f'0-release-{latest}.pdf')
          rename(pdfs_root / 'å°é¢.pdf', pdfs_root / f'1-release-{latest}.pdf')
          with open('release_body', 'w', encoding='utf8') as f:
              print('ç”±äºŽ GitHub ä¸Šä¼  release èµ„æºæ—¶ä¸æ”¯æŒåŒ…å«ç‰¹æ®Šå­—ç¬¦å’Œ Unicode çš„æ–‡ä»¶åï¼Œæ–‡ä»¶å·²è¢«é‡å‘½åã€‚å•å‡»æ ‡é¢˜å°†è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼š', file=f)
              print(f'- ### **[çº¢çŸ³æ•°ç”µè¯„è®º ç¬¬{latest}æœŸ](https://github.com/ARS-MC/RRDC/releases/download/release-{latest}/0-release-{latest}.pdf)**', file=f)
              print(f'- [å°é¢](https://github.com/ARS-MC/RRDC/releases/download/release-{latest}/1-release-{latest}.pdf) (pp. 1-2)', file=f)
              index = 2
              current_page = 3
              for type_ in ('è®ºæ–‡', 'é€šè®¯'):
                  print(f'- {type_}', file=f)
                  # èŽ·å–é¡µç 
                  articles = [(
                      name, author,
                      int(next(filter(
                          lambda s: s.startswith('NumberOfPages:'),
                          popen(f'pdftk {pdfs_root / (name + ".pdf")} dump_data_utf8').read().splitlines(keepends=False)
                      )).split(' ')[1])
                  ) for name, author in contents[type_]]
                  # é‡å‘½å pdf æ–‡ä»¶å¹¶ç”Ÿæˆ release ä¿¡æ¯
                  for name, author, page in articles:
                      rename(pdfs_root / f'{name}.pdf', pdfs_root / f'{index}-release-{latest}.pdf')
                      if page > 1:
                          print(f'    - [{name}](https://github.com/ARS-MC/RRDC/releases/download/release-{latest}/{index}-release-{latest}.pdf) `{author}` (pp. {current_page}-{current_page + page - 1})', file=f)
                      else:
                          print(f'    - [{name}](https://github.com/ARS-MC/RRDC/releases/download/release-{latest}/{index}-release-{latest}.pdf) `{author}` (p. {current_page})', file=f)
                      index += 1
                      current_page += page
      - uses: anothrNick/github-tag-action@1.36.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CUSTOM_TAG: ${{ format('release-{0}', env.LATEST) }}
      - uses: softprops/action-gh-release@v0.1.14
        with:
          tag_name: ${{ format('release-{0}', env.LATEST) }}
          name: ${{ format('çº¢çŸ³æ•°ç”µè¯„è®º ç¬¬ {0} æœŸ ðŸŽ‰', env.LATEST) }}
          body_path: ${{ github.workspace }}/release_body
          files: ./pdfs/*.pdf
